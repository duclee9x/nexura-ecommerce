name: gitops-pipeline
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
jobs:
  build-and-push-images:
    name: build-and-push-images
    runs-on: self-hosted
    environment: dev
    steps:
        - name: Checkout
          uses: actions/checkout@v4
          with:
            path: app

        - name: Get changed files
          id: diff-version
          working-directory: app
          run: |
            git fetch origin main
            echo "services=$(services=$(git diff --name-only origin/main...HEAD | grep '^src/' | cut -d '/' -f2 | uniq | cut -d '-' -f1 | tr '\n' ',' | sed 's/,$//'); [[ -z \"$services\" ]] && echo 'user,product,payment,order,cart,frontend,workflow' || echo \"$services\")" >> $GITHUB_OUTPUT

        - name: Set image version
          id: vars
          working-directory: app
          run: echo "version=$(TZ='Asia/Ho_Chi_Minh' date +%Y%m%d)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

        - name: Write secrets to .env file
          if: ${{ vars.PUSH_NEEDED == 'true' }}
          working-directory: app/.dagger
          run: |
            echo "NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY=${{ secrets.NEXT_PUBLIC_IMAGEKIT_PUBLIC_KEY }}" >> .env
            echo "NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT=${{ secrets.NEXT_PUBLIC_IMAGEKIT_URL_ENDPOINT }}" >> .env
            echo "NEXT_PUBLIC_IMAGEKIT_PRIVATE_KEY=${{ secrets.NEXT_PUBLIC_IMAGEKIT_PRIVATE_KEY }}" >> .env
            echo "SESSION_SECRET=${{ secrets.SESSION_SECRET }}}" >> .env

        - name: Login to Docker Hub
          if: ${{ vars.PUSH_NEEDED == 'true' }}
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: build services
          uses: dagger/dagger-for-github@8.0.0
          if: ${{ vars.PUSH_NEEDED == 'true' }}
          with: 
            workdir: app/.dagger
            args: build-and-push-images --services=${{ steps.diff-version.outputs.services }} --version=${{ steps.vars.outputs.version }} --frontend-secret=file://.env --snyk-token=${{ secrets.SNYK_TOKEN }}
            module: https://${{ secrets.SSH_PRIVATE_KEY}}@github.com/duclee9x/nexura-ecommerce.git/.dagger

        - name: checkout rendered manifest repo
          uses: actions/checkout@v4
          with:
            repository: duclee9x/nexura-rendered-manifest
            token: ${{ secrets.SSH_PRIVATE_KEY }}
            path: manifest

        - name: Setup helm
          uses: azure/setup-helm@v4.3.0
          with:
            version: 'v3.17.0'

        - name: Sops Binary Installer
          uses: mdgreenwald/mozilla-sops-action@v1.6.0
          with:
            version: 'latest'
          id: install
          
        - name: Generate manifest using helm
          working-directory: app
          env: 
            SOPS_AGE_KEY: ${{ secrets.AGE_ENCRYPT_KEY }}
          run: |
            set -x
            chmod +x ./sops-all.sh
            chmod +x ./gen-manifest.sh
            ./sops-all.sh decrypt .
            ./gen-manifest.sh --enable-apps=${{ vars.PUSH_NEEDED }} --version ${{ steps.vars.outputs.version }} ${{ steps.diff-version.outputs.services }} 
        
        # - name: encrypt manifest repo
        #   working-directory: manifest
        #   env:
        #     SOPS_AGE_KEY: ${{ secrets.AGE_ENCRYPT_KEY }}
        #   run: |
        #     ./sops-all.sh encrypt

        - name: Create Pull Request
          uses: peter-evans/create-pull-request@v7
          with:
            path: manifest
            token: ${{ secrets.SSH_PRIVATE_KEY }}
            commit-message: Update report
            committer: github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
            author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>
            signoff: false
            branch: generator-${{ steps.vars.outputs.version }}
            delete-branch: true
            title: '[NEW VERSION] Update manifest'
            body: |
              - Auto-generated by [create-pull-request][1]

              [1]: https://github.com/peter-evans/create-pull-request
            labels: |
              deployment request
              automated pr
            assignees: duclee9x
            draft: false




